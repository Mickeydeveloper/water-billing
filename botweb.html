<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIDA / TIN Information Manager</title>
  <script src="https://mega.nz/js/v4/mega.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f0f7ff, #e0f2fe); min-height: 100vh; }
    .card { background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .loaded { animation: pulse 2s; }
    @keyframes pulse { 0%,100% { background-color: #ecfdf5; } 50% { background-color: #d1fae5; } }
  </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-2xl mx-auto">
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-indigo-700 mb-2">NIDA & TIN Manager</h1>
    <p class="text-gray-600">Auto-save & auto-load your data from MEGA</p>
  </div>

  <div class="card p-8" id="formCard">
    <form id="nidaForm" class="space-y-6">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">1. Namba yako ya NIDA</label>
        <input type="text" id="nida" placeholder="e.g. 19870909-59418-00001-22" 
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none transition">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">2. Namba ya simu ya mawasiliano</label>
        <input type="text" id="phone" placeholder="07XXXXXXXX" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">3. Majina matatu ya mama</label>
        <input type="text" id="mother" placeholder="MAJINA MATATU YA MAMA" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">4. Shule ya msingi uliyo hitimu darasa la saba</label>
        <input type="text" id="primarySchool" placeholder="Jina la shule ya msingi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">5. Mwaka uliomaliza shule ya msingi</label>
        <input type="text" id="year" placeholder="2005" maxlength="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">6. Wilaya uliyo hitimu darasa la saba</label>
        <input type="text" id="regionPrimary" placeholder="Wilaya ya shule ya msingi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">7. Wilaya unayoishi sasa</label>
        <input type="text" id="currentRegion" placeholder="Wilaya unayoishi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none">
      </div>

      <div class="pt-6 flex gap-4">
        <button type="button" id="loginMega" 
                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 rounded-lg hover:from-green-600 hover:to-green-700 transition shadow-lg">
          Login to MEGA
        </button>
        <button type="submit" id="saveBtn" disabled
                class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition shadow-lg opacity-50">
          Save to MEGA
        </button>
      </div>

      <div id="status" class="text-center text-sm font-medium mt-4 min-h-10"></div>
    </form>
  </div>

  <div class="text-center mt-6 text-gray-500 text-xs">
    Your data is end-to-end encrypted • Auto-saved & auto-loaded from your MEGA account
  </div>
</div>

<script>
  let megaUser = null;
  const status = document.getElementById('status');
  const saveBtn = document.getElementById('saveBtn');
  const loginBtn = document.getElementById('loginMega');
  const formCard = document.getElementById('formCard');

  // Helper: Set form values
  function fillForm(data) {
    document.getElementById('nida').value = data.nida || '';
    document.getElementById('phone').value = data.phone || '';
    document.getElementById('mother').value = data.motherName || '';
    document.getElementById('primarySchool').value = data.primarySchool || '';
    document.getElementById('year').value = data.yearCompleted || '';
    document.getElementById('regionPrimary').value = data.regionPrimary || '';
    document.getElementById('currentRegion').value = data.currentRegion || '';

    // Visual feedback
    formCard.classList.add('loaded');
    setTimeout(() => formCard.classList.remove('loaded'), 3000);
  }

  // Auto-load latest saved data after login
  async function loadLatestData() {
    if (!megaUser) return;

    status.textContent = "Scanning your MEGA drive for previous data...";

    try {
      const root = megaUser.getCloudDrive();
      const files = await root.getFiles();
      const nidaFiles = Object.values(files.children || {})
        .filter(f => f.name && f.name.startsWith('NIDA_Info_') && f.name.endsWith('.json'))
        .sort((a, b) => (b.modified || b.t) - (a.modified || a.t)); // newest first

      if (nidaFiles.length === 0) {
        status.innerHTML = "No previous data found. Fill and save!";
        return;
      }

      const latest = nidaFiles[0];
      status.textContent = `Loading your latest data: ${latest.name}...`;

      const download = latest.download();
      const buffer = await download.complete();
      const text = new TextDecoder().decode(buffer);
      const data = JSON.parse(text);

      fillForm(data);
      status.innerHTML = `Data auto-loaded from<br><strong>\( {latest.name}</strong><br>Saved on: \){new Date(data.savedAt).toLocaleString('sw-TZ')}`;
      
    } catch (err) {
      console.error("Auto-load failed:", err);
      status.textContent = "Could not load previous data (check connection)";
    }
  }

  // Login Button
  loginBtn.addEventListener('click', async () => {
    status.textContent = "Opening MEGA login...";
    try {
      megaUser = await mega.login();
      status.innerHTML = `Logged in as <strong>${megaUser.name}</strong>`;
      saveBtn.disabled = false;
      saveBtn.classList.remove('opacity-50');
      loginBtn.textContent = "Logged In ✓";
      loginBtn.disabled = true;

      // Auto-load data after successful login
      setTimeout(loadLatestData, 1000);

    } catch (err) {
      status.textContent = "Login cancelled or failed";
    }
  });

  // Save Form
  document.getElementById('nidaForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!megaUser) return alert("Login first!");

    const data = {
      nida: document.getElementById('nida').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      motherName: document.getElementById('mother').value.trim(),
      primarySchool: document.getElementById('primarySchool').value.trim(),
      yearCompleted: document.getElementById('year').value.trim(),
      regionPrimary: document.getElementById('regionPrimary').value.trim(),
      currentRegion: document.getElementById('currentRegion').value.trim(),
      savedAt: new Date().toISOString()
    };

    if (!data.nida || !data.motherName || !data.primarySchool) {
      return alert("Fill NIDA number, Mother's name, and Primary school first!");
    }

    const jsonData = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const filename = `NIDA_Info_\( {data.nida}_ \){Date.now()}.json`;

    status.textContent = "Uploading to MEGA...";

    try {
      const upload = megaUser.upload({ name: filename, size: blob.size });
      
      upload.addEventListener('progress', (e) => {
        if (e.total) status.textContent = `Uploading... ${Math.round(e.loaded / e.total * 100)}%`;
      });

      await upload.complete(blob);
      status.innerHTML = `Saved successfully!<br>File: <strong>${filename}</strong><br>Auto-load next time!`;

    } catch (err) {
      console.error(err);
      status.textContent = "Upload failed. Try again.";
    }
  });
</script>

</body>
</html>