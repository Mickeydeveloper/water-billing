<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NIDA - Hifadhi & Tuma</title>
  <script src="https://mega.nz/js/v4/mega.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: system-ui; background: #f0f9ff; }
    .card { background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.12); }
  </style>
</head>
<body class="p-4 min-h-screen">

<div class="max-w-xl mx-auto pt-8">
  <h1 class="text-3xl font-bold text-center text-indigo-800 mb-6">NIDA / TIN Info</h1>

  <div class="card p-6 space-y-5">
    <input type="text" id="nida" placeholder="1. Namba ya NIDA" class="w-full p-4 rounded-xl border text-lg">
    <input type="text" id="phone" placeholder="2. Namba ya simu" class="w-full p-4 rounded-xl border text-lg">
    <input type="text" id="mother" placeholder="3. Majina matatu ya mama" class="w-full p-4 rounded-xl border text-lg">
    <input type="text" id="primarySchool" placeholder="4. Shule ya msingi" class="w-full p-4 rounded-xl border text-lg">
    <input type="text" id="year" placeholder="5. Mwaka uliomaliza darasa la saba" class="w-full p-4 rounded-xl border text-lg">
    <input type="text" id="regionPrimary" placeholder="6. Wilaya uliyohitimu darasa la saba" class="w-full p-4 rounded-xl border text-lg">
    <input type="text" id="currentRegion" placeholder="7. Wilaya unayoishi sasa" class="w-full p-4 rounded-xl border text-lg">

    <div class="grid grid-cols-1 gap-4 pt-6">
      <button id="saveAll" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-5 rounded-xl text-xl">
        Hifadhi MEGA + Tuma WhatsApp/SMS
      </button>
    </div>

    <div id="status" class="text-center font-bold text-lg mt-4"></div>
  </div>
</div>

<script>
  let user = null;

  // Auto-login if already logged in to MEGA
  mega.ready.then(() => { if (mega.getUser()) user = mega.getUser(); });

  document.getElementById('saveAll').onclick = async () => {
    const data = {
      nida: document.getElementById('nida').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      motherName: document.getElementById('mother').value.trim(),
      primarySchool: document.getElementById('primarySchool').value.trim(),
      yearCompleted: document.getElementById('year').value.trim(),
      regionPrimary: document.getElementById('regionPrimary').value.trim(),
      currentRegion: document.getElementById('currentRegion').value.trim(),
    };

    if (!data.nida || !data.motherName || !data.primarySchool) {
      return alert("Jaza angalau: NIDA, Mama, na Shule ya Msingi");
    }

    // 1. Save to MEGA (if logged in)
    if (user) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const filename = `NIDA_\( {data.nida}_ \){Date.now()}.json`;
      try { await user.upload({name: filename}).complete(blob); } catch(e) {}
    }

    // 2. Generate beautiful PDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFont("helvetica", "bold");
    doc.setFontSize(20);
    doc.text("TAARIFA ZA NIDA", 105, 20, null, null, "center");

    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    let y = 40;
    for (const [key, value] of Object.entries(data)) {
      if (value) {
        const label = {
          nida: "Namba ya NIDA",
          phone: "Simu",
          motherName: "Majina ya Mama",
          primarySchool: "Shule ya Msingi",
          yearCompleted: "Mwaka wa Darasa la Saba",
          regionPrimary: "Wilaya ya Shule",
          currentRegion: "Wilaya Unayoishi"
        }[key];
        doc.text(`\( {label}: \){value}`, 20, y);
        y += 12;
      }
    }
    doc.text(`Imehifadhiwa: ${new Date().toLocaleString('sw-TZ')}`, 20, y + 10);

    const pdfBlob = doc.output('blob');
    const pdfUrl = URL.createObjectURL(pdfBlob);

    // 3. Plain text for SMS
    const textMsg = Object.entries(data)
      .filter(([k,v]) => v)
      .map(([k,v]) => {
        const labels = {nida:"NIDA", phone:"Simu", motherName:"Mama", primarySchool:"Shule", yearCompleted:"Mwaka", regionPrimary:"Wilaya Shule", currentRegion:"Wilaya Sasa"};
        return `\( {labels[k]}: \){v}`;
      }).join("\n");

    // 4. Show share buttons
    document.getElementById('status').innerHTML = `
      <div class="space-y-4 mt-6">
        <a href="whatsapp://send?text=${encodeURIComponent(textMsg)}" 
           class="block bg-green-500 text-white text-center py-4 rounded-xl font-bold text-xl">
           Tuma WhatsApp (Text)
        </a>
        <a href="\( {pdfUrl}" download="NIDA_MyInfo_ \){data.nida}.pdf" 
           class="block bg-blue-600 text-white text-center py-4 rounded-xl font-bold text-xl">
           Pakua PDF
        </a>
        <a href="sms:?body=${encodeURIComponent(textMsg)}" 
           class="block bg-gray-700 text-white text-center py-4 rounded-xl font-bold text-xl">
           Tuma SMS
        </a>
      </div>`;
  };
</script>
</body>
</html>