<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekodi za Data Zilizoboreshwa - Graphy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #2c3e50; text-align: center; }
        .controls { text-align: center; margin-bottom: 20px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
        button { padding: 10px 15px; background-color: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .add-btn { background-color: #3498db; }
        .reset-btn { background-color: #e74c3c; }
        #data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; }
        #data-table th, #data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; min-width: 60px; }
        #data-table th { background-color: #34495e; color: white; }
        .editable { background-color: #ecf0f1; }
        #status-message { text-align: center; margin-top: 10px; font-weight: bold; height: 20px; }
        .mega-config { display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap; }
        .mega-config input { padding:6px; }
    </style>
</head>
<body>

    <h1>üìä Rekodi za Data Zilizoboreshwa (Graphy)</h1>

    <div class="controls">
        <button onclick="saveData()">Hifadhi Mabadiliko (Save)</button>
        <button class="add-btn" onclick="addRecord()">‚ûï Ongeza Mtu/Rekodi</button>
        <button class="add-btn" onclick="addColumn()">‚ûï Ongeza Mwezi/Safu Wima</button>
        <button class="reset-btn" onclick="resetData()">‚ôªÔ∏è Anzisha Upya (Reset)</button>
    </div>

    <div class="mega-config">
        <input id="mega-email" placeholder="MEGA email" />
        <input id="mega-password" placeholder="MEGA password" type="password" />
        <input id="mega-filename" placeholder="filename (graphy.json)" value="graphy.json" />
        <button onclick="saveCredentials()">Save Creds</button>
        <button onclick="saveToMega()">Save to MEGA</button>
    </div>

    <div id="status-message"></div>

    <div style="overflow-x:auto;">
        <table id="data-table">
            <thead>
                <tr id="table-header-row">
                    <th>JINA</th>
                    </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>

    <script>
        const initialData = [];
        const initialHeaders = [];
        const localStorageKey = 'recordDataEnhanced';
        const localStorageHeadersKey = 'recordHeadersEnhanced';
        const tableBody = document.getElementById('table-body');
        const tableHeaderRow = document.getElementById('table-header-row');
        const statusMessage = document.getElementById('status-message');

        function loadData() {
            const savedData = localStorage.getItem(localStorageKey);
            const savedHeaders = localStorage.getItem(localStorageHeadersKey);
            let data = initialData;
            let headers = initialHeaders;
            if (savedData && savedHeaders) {
                try { data = JSON.parse(savedData); headers = JSON.parse(savedHeaders); showMessage("Data iliyohifadhiwa imepakiwa.", "green"); }
                catch (e) { showMessage("Hitilafu katika kupakia data iliyohifadhiwa. Data ya awali inatumika.", "red"); }
            } else {
                localStorage.setItem(localStorageHeadersKey, JSON.stringify(initialHeaders));
                localStorage.setItem(localStorageKey, JSON.stringify(initialData));
                showMessage("Imeanzishwa bila rekodi (meza tupu). Ongeza watu/kolamu na uhifadhi.", "blue");
            }
            renderTable(data, headers);
        }

        function renderTable(data, headers) {
            tableHeaderRow.innerHTML = '<th>JINA</th>';
            headers.forEach((header, colIndex) => {
                const th = document.createElement('th');
                th.setAttribute('contenteditable', 'true');
                th.innerHTML = `${header} <button class="col-del" data-col="${colIndex}">‚úñ</button>`;
                tableHeaderRow.appendChild(th);
            });
            const actionsTh = document.createElement('th'); actionsTh.textContent = 'TINYAGO'; tableHeaderRow.appendChild(actionsTh);
            tableBody.innerHTML = '';
            data.forEach(item => {
                const row = tableBody.insertRow();
                let nameCell = row.insertCell(); nameCell.textContent = item.JINA || ''; nameCell.setAttribute('contenteditable', 'true');
                headers.forEach(header => { let scoreCell = row.insertCell(); scoreCell.textContent = item[header] !== undefined ? item[header] : ''; scoreCell.setAttribute('contenteditable', 'true'); scoreCell.classList.add('editable'); });
                const actionCell = row.insertCell(); const delBtn = document.createElement('button'); delBtn.textContent = 'Futa'; delBtn.style.background = '#e74c3c'; delBtn.style.color = '#fff'; delBtn.style.border = 'none'; delBtn.style.padding = '6px 8px'; delBtn.style.borderRadius = '4px';
                delBtn.addEventListener('click', () => { if (confirm('Una uhakika unataka kufuta rekodi hii?')) { row.remove(); saveData(); showMessage('Rekodi imefutwa.', 'orange'); } });
                actionCell.appendChild(delBtn);
            });
            document.querySelectorAll('#table-header-row th[contenteditable="true"]').forEach(th => { th.addEventListener('blur', updateHeadersInLocalStorage); });
            document.querySelectorAll('.col-del').forEach(btn => { btn.addEventListener('click', (e) => { const colIndex = parseInt(e.currentTarget.getAttribute('data-col')); if (confirm('Una uhakika unataka kufuta safu hii (kolamu)?')) { deleteColumnByIndex(colIndex); } }); });
        }

        function saveData() {
            const { data, headers } = getTableData();
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(data));
                localStorage.setItem(localStorageHeadersKey, JSON.stringify(headers));
                showMessage("‚úÖ Mabadiliko yamehifadhiwa kwa ufanisi!", "green");
            } catch (e) {
                // improved error reporting
                showMessage("‚ùå Kushindwa kuhifadhi. Kosa: " + (e && e.message ? e.message : String(e)), "red");
            }
        }

        function getTableData() {
            const data = [];
            const rows = tableBody.querySelectorAll('tr');
            const headerCells = tableHeaderRow.querySelectorAll('th');
            const headers = Array.from(headerCells).map(th => th.textContent.trim()).filter(h => h && h !== 'JINA');
            rows.forEach(row => { const cells = row.querySelectorAll('td'); const rowData = {}; if (cells.length > 0) { rowData['JINA'] = cells[0].textContent.trim(); headers.forEach((header, index) => { if (cells[index + 1]) { rowData[header] = cells[index + 1].textContent.trim(); } }); data.push(rowData); } });
            return { data, headers };
        }

        function updateHeadersInLocalStorage() { const { data, headers } = getTableData(); localStorage.setItem(localStorageHeadersKey, JSON.stringify(headers)); }

        function resetData() { if (confirm("Uko karibu kufuta data yote iliyohifadhiwa na kurudi kwenye data ya awali. Una uhakika?")) { localStorage.removeItem(localStorageKey); localStorage.removeItem(localStorageHeadersKey); loadData(); showMessage("Data imefutwa na kurudishwa kwenye hali ya awali.", "orange"); } }
        function clearData() { resetData(); }
        function showMessage(msg, color) { statusMessage.textContent = msg; statusMessage.style.color = color; setTimeout(() => { statusMessage.textContent = ''; }, 4000); }

        function addRecord() { const currentHeaders = getTableData().headers; const row = tableBody.insertRow(); let nameCell = row.insertCell(); nameCell.textContent = "Jina Jipya"; nameCell.setAttribute('contenteditable', 'true'); currentHeaders.forEach(() => { let scoreCell = row.insertCell(); scoreCell.textContent = ""; scoreCell.setAttribute('contenteditable', 'true'); scoreCell.classList.add('editable'); }); saveData(); showMessage("Rekodi mpya imeongezwa.", "blue"); }

        function addColumn() { const { data, headers } = getTableData(); let newHeaderNumber = 1; if (headers.length > 0) { const numericHeaders = headers.map(h => parseInt(h)).filter(n => !isNaN(n)); if (numericHeaders.length > 0) { newHeaderNumber = Math.max(...numericHeaders) + 1; } } const newHeader = String(newHeaderNumber); headers.push(newHeader); data.forEach(item => { item[newHeader] = ''; }); renderTable(data, headers); saveData(); showMessage(`Mwezi/Safu Wima '${newHeader}' imeongezwa.`, "blue"); }

        function deleteColumnByIndex(colIndex) { const { data, headers } = getTableData(); if (colIndex < 0 || colIndex >= headers.length) return; const headerToRemove = headers[colIndex]; headers.splice(colIndex, 1); data.forEach(item => { delete item[headerToRemove]; }); renderTable(data, headers); saveData(); showMessage(`Safu '${headerToRemove}' imefutwa.`, 'orange'); }

        // MEGA helpers
        function saveCredentials() { const email = document.getElementById('mega-email').value; const password = document.getElementById('mega-password').value; const filename = document.getElementById('mega-filename').value || 'graphy.json'; localStorage.setItem('megaCreds', JSON.stringify({ email, password, filename })); showMessage('MEGA credentials saved (in browser localStorage).', 'green'); }

        async function saveToMega() {
            const creds = JSON.parse(localStorage.getItem('megaCreds') || '{}');
            const email = creds.email || document.getElementById('mega-email').value;
            const password = creds.password || document.getElementById('mega-password').value;
            const filename = document.getElementById('mega-filename').value || creds.filename || 'graphy.json';
            if (!email || !password) { showMessage('Tafadhali weka MEGA email na password.', 'red'); return; }
            const { data, headers } = getTableData();
            const content = JSON.stringify({ data, headers });
            try {
                const resp = await fetch('/save-to-mega', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, filename, content })
                });
                const body = await resp.json();
                if (!resp.ok) throw new Error(body.error || 'Unknown server error');
                showMessage('‚úÖ Imehifadhiwa kwenye MEGA.', 'green');
            } catch (e) {
                showMessage('‚ùå MEGA save failed: ' + e.message, 'red');
            }
        }

        window.onload = loadData;
    </script>

</body>
</html>
